generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id             String   @id @default(cuid())
  secondmeUserId String   @unique @map("secondme_user_id")
  email          String?
  name           String?
  avatarUrl      String?  @map("avatar_url")
  shadesJson     String?  @map("shades_json")
  personalityType   String?  @map("personality_type")
  personalityScores String?  @map("personality_scores")
  accessToken    String   @map("access_token")
  refreshToken   String   @map("refresh_token")
  tokenExpiresAt DateTime @map("token_expires_at")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  matchesAsA  Match[]     @relation("matchesAsA")
  matchesAsB  Match[]     @relation("matchesAsB")
  topicPosts  TopicPost[]

  @@map("users")
}

model Match {
  id        String   @id @default(cuid())
  userAId   String   @map("user_a_id")
  userBId   String   @map("user_b_id")
  score     Int      @default(0)
  report    String   @default("{}")
  chatLog   String   @default("[]")
  status    String   @default("processing")
  createdAt DateTime @default(now()) @map("created_at")

  userA User @relation("matchesAsA", fields: [userAId], references: [id])
  userB User @relation("matchesAsB", fields: [userBId], references: [id])

  @@map("matches")
}

model Topic {
  id        String      @id @default(cuid())
  title     String
  createdAt DateTime    @default(now()) @map("created_at")
  posts     TopicPost[]

  @@map("topics")
}

model TopicPost {
  id              String   @id @default(cuid())
  topicId         String   @map("topic_id")
  topic           Topic    @relation(fields: [topicId], references: [id])
  userId          String   @map("user_id")
  user            User     @relation(fields: [userId], references: [id])
  floor           Int
  content         String
  personalityType String   @map("personality_type")
  likes           Int      @default(0)
  createdAt       DateTime @default(now()) @map("created_at")

  @@map("topic_posts")
}

model Danmaku {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  username  String
  message   String
  color     String   @default("#FFFFFF")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("danmaku")
}

model AIHighlight {
  id        String   @id @default(cuid())
  content   String
  topic     String
  speakerA  String   @map("speaker_a")
  speakerB  String   @map("speaker_b")
  likes     Int      @default(0)
  createdAt DateTime @default(now()) @map("created_at")

  @@map("ai_highlights")
}

model Room {
  id               String        @id @default(cuid())
  name             String
  shareCode        String        @unique @map("share_code")
  status           String        @default("waiting")
  currentRound     Int           @default(0) @map("current_round")
  maxRounds        Int           @default(2) @map("max_rounds")
  autoAdvance      Boolean       @default(true) @map("auto_advance")
  countdownSeconds Int           @default(30) @map("countdown_seconds")
  createdAt        DateTime      @default(now()) @map("created_at")
  updatedAt        DateTime      @updatedAt @map("updated_at")
  members          RoomMember[]
  pairings         RoundPairing[]

  @@map("rooms")
}

model RoomMember {
  id              String         @id @default(cuid())
  roomId          String         @map("room_id")
  room            Room           @relation(fields: [roomId], references: [id])
  nickname        String
  personalityType String         @map("personality_type")
  surveyAnswers   String         @map("survey_answers")
  avatarSeed      Int            @default(0) @map("avatar_seed")
  isCreator       Boolean        @default(false) @map("is_creator")
  joinedAt        DateTime       @default(now()) @map("joined_at")
  pairingsA       RoundPairing[] @relation("memberA")
  pairingsB       RoundPairing[] @relation("memberB")

  @@map("room_members")
}

model RoundPairing {
  id               String     @id @default(cuid())
  roomId           String     @map("room_id")
  room             Room       @relation(fields: [roomId], references: [id])
  round            Int
  memberAId        String     @map("member_a_id")
  memberA          RoomMember @relation("memberA", fields: [memberAId], references: [id])
  memberBId        String     @map("member_b_id")
  memberB          RoomMember @relation("memberB", fields: [memberBId], references: [id])
  conversationData String     @default("[]") @map("conversation_data")
  highlights       String     @default("[]")
  matchScore       Int        @default(0) @map("match_score")
  status           String     @default("pending")
  createdAt        DateTime   @default(now()) @map("created_at")

  @@map("round_pairings")
}
